import React, { useEffect, useMemo, useState } from "react";
import { MapContainer, TileLayer, Marker, Popup, Polyline } from "react-leaflet";
import "leaflet/dist/leaflet.css";
import { Icon } from "leaflet";

// --- Minimal marker icon (Leaflet's default icon requires assets). We'll draw a simple circle via DivIcon-like style.
const dotSvg = encodeURIComponent(
  `<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'>
    <circle cx='12' cy='12' r='8' fill='#ef4444' stroke='white' stroke-width='3'/>
  </svg>`
);
const dotIcon = new Icon({
  iconUrl: `data:image/svg+xml,${dotSvg}`,
  iconSize: [24, 24],
  iconAnchor: [12, 12],
});

const CITIES = [
  { name: "New Delhi", lat: 28.6139, lon: 77.2090, bbox: [77.10, 28.56, 77.30, 28.70] },
  { name: "Mumbai", lat: 19.0760, lon: 72.8777, bbox: [72.80, 18.90, 72.95, 19.15] },
  { name: "Hyderabad", lat: 17.3850, lon: 78.4867, bbox: [78.35, 17.30, 78.60, 17.50] },
  { name: "Kolkata", lat: 22.5726, lon: 88.3639, bbox: [88.25, 22.45, 88.45, 22.65] },
  { name: "Bengaluru", lat: 12.9716, lon: 77.5946, bbox: [77.45, 12.85, 77.70, 13.10] },
  { name: "Kochi", lat: 9.9312, lon: 76.2673, bbox: [76.20, 9.85, 76.35, 10.05] },
  { name: "Shillong", lat: 25.5788, lon: 91.8933, bbox: [91.80, 25.50, 92.00, 25.65] },
  { name: "Kanpur", lat: 26.4499, lon: 80.3319, bbox: [80.20, 26.35, 80.45, 26.55] },
];

// Color scale for EU AQI labels
const aqiColor = (label) => ({
  Good: "#16a34a",
  Fair: "#84cc16",
  Moderate: "#f59e0b",
  Poor: "#f97316",
  "Very poor": "#ef4444",
  "Extremely poor": "#7f1d1d",
}[label] || "#6b7280");

async function fetchAirQuality(lat, lon) {
  const params = new URLSearchParams({
    latitude: lat.toString(),
    longitude: lon.toString(),
    timezone: "auto",
    hourly: [
      "european_aqi",
      "european_aqi_label",
      "pm2_5",
      "pm10",
      "ozone",
      "nitrogen_dioxide",
      "sulphur_dioxide",
      "carbon_monoxide",
    ].join(","),
    past_days: "1",
    forecast_days: "1",
  });
  const url = `https://air-quality-api.open-meteo.com/v1/air-quality?${params.toString()}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("Air quality fetch failed");
  const j = await res.json();
  const H = j?.hourly || {};
  const i = (H.time?.length || 0) - 1; // take last
  if (i < 0) throw new Error("No AQ data");
  return {
    time: H.time[i],
    aqi: H.european_aqi?.[i] ?? null,
    aqiLabel: H.european_aqi_label?.[i] ?? null,
    pm25: H.pm2_5?.[i] ?? null,
    pm10: H.pm10?.[i] ?? null,
    o3: H.ozone?.[i] ?? null,
    no2: H.nitrogen_dioxide?.[i] ?? null,
    so2: H.sulphur_dioxide?.[i] ?? null,
    co: H.carbon_monoxide?.[i] ?? null,
  };
}

async function tryFetchJSON(url) {
  try {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) return null;
    return await r.json();
  } catch {
    return null;
  }
}

export default function App() {
  const [selected, setSelected] = useState(CITIES[0]);
  const [aq, setAQ] = useState(null);
  const [loadingAQ, setLoadingAQ] = useState(false);
  const [flow, setFlow] = useState(null);
  const [incidents, setIncidents] = useState([]);

  // fetch AQ when city changes
  useEffect(() => {
    let alive = true;
    (async () => {
      setLoadingAQ(true);
      const data = await fetchAirQuality(selected.lat, selected.lon).catch(() => null);
      if (alive) { setAQ(data); setLoadingAQ(false); }
    })();
    return () => { alive = false };
  }, [selected]);

  // try to fetch traffic from local backend (api_flow.php / api_incidents.php)
  useEffect(() => {
    let alive = true;
    (async () => {
      const f = await tryFetchJSON(`/api_flow.php?lat=${selected.lat}&lon=${selected.lon}&zoom=10`);
      const bbox = selected.bbox.join(",");
      const inc = await tryFetchJSON(`/api_incidents.php?bbox=${bbox}`);
      if (!alive) return;
      setFlow(f);
      setIncidents(inc?.incidents || []);
    })();
    return () => { alive = false };
  }, [selected]);

  const center = useMemo(() => [selected.lat, selected.lon], [selected]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-zinc-900 via-zinc-900 to-black text-white">
      <div className="mx-auto max-w-6xl px-4 py-6">
        <header className="flex items-center justify-between gap-4">
          <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">Smog Bharat</h1>
          <p className="text-zinc-400 text-sm">Wähle eine Stadt – Luft & Verkehr live</p>
        </header>

        <section className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="md:col-span-2 rounded-2xl overflow-hidden ring-1 ring-zinc-800 shadow-xl">
            <MapContainer center={center} zoom={11} scrollWheelZoom className="h-[460px]">
              <TileLayer
                attribution='&copy; OpenStreetMap & TomTom'
                url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
              />
              {CITIES.map((c) => (
                <Marker key={c.name} position={[c.lat, c.lon]} icon={dotIcon} eventHandlers={{ click: () => setSelected(c) }}>
                  <Popup>
                    <div className="space-y-1">
                      <div className="font-medium">{c.name}</div>
                      <button className="px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 text-xs" onClick={() => setSelected(c)}>Wählen</button>
                    </div>
                  </Popup>
                </Marker>
              ))}

              {/* Draw incidents if available (as polylines) */}
              {incidents.map((i, idx) => {
                const coords = i?.geometry?.coordinates?.[0] || [];
                if (!coords.length) return null;
                const latlngs = coords.map(([lon, lat]) => [lat, lon]);
                return <Polyline key={idx} positions={latlngs} pathOptions={{ color: "#ef4444", weight: 5, opacity: 0.8 }} />
              })}
            </MapContainer>
          </div>

          <div className="space-y-4">
            <div className="rounded-2xl p-4 ring-1 ring-zinc-800 bg-zinc-900/40">
              <label className="block text-xs uppercase tracking-wider text-zinc-400 mb-2">Stadt</label>
              <select
                className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                value={selected.name}
                onChange={(e) => setSelected(CITIES.find(c => c.name === e.target.value) || CITIES[0])}
              >
                {CITIES.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
              </select>
            </div>

            <div className="rounded-2xl p-4 ring-1 ring-zinc-800 bg-zinc-900/40">
              <div className="flex items-center justify-between mb-2">
                <span className="text-xs uppercase tracking-wider text-zinc-400">Air Quality (EU AQI)</span>
                <span className="text-xs text-zinc-500">{aq?.time ? new Date(aq.time).toLocaleString() : ""}</span>
              </div>
              {loadingAQ ? (
                <div className="animate-pulse h-24 bg-zinc-800/50 rounded-xl" />
              ) : aq ? (
                <div className="space-y-3">
                  <div className="flex items-center gap-3">
                    <div className="text-4xl font-semibold" style={{ color: aqiColor(aq.aqiLabel) }}>{Math.round(aq.aqi)}</div>
                    <span className="px-3 py-1 rounded-full text-sm" style={{ backgroundColor: aqiColor(aq.aqiLabel) + "33" }}>
                      {aq.aqiLabel || "–"}
                    </span>
                  </div>
                  <div className="grid grid-cols-2 gap-2 text-sm text-zinc-300">
                    <div className="rounded-xl bg-zinc-900/60 p-3">PM2.5: <b>{aq.pm25?.toFixed?.(1) ?? "–"}</b> µg/m³</div>
                    <div className="rounded-xl bg-zinc-900/60 p-3">PM10: <b>{aq.pm10?.toFixed?.(1) ?? "–"}</b> µg/m³</div>
                    <div className="rounded-xl bg-zinc-900/60 p-3">NO₂: <b>{aq.no2?.toFixed?.(0) ?? "–"}</b> µg/m³</div>
                    <div className="rounded-xl bg-zinc-900/60 p-3">O₃: <b>{aq.o3?.toFixed?.(0) ?? "–"}</b> µg/m³</div>
                  </div>
                </div>
              ) : (
                <div className="text-zinc-400 text-sm">Keine AQ-Daten.</div>
              )}
            </div>

            <div className="rounded-2xl p-4 ring-1 ring-zinc-800 bg-zinc-900/40">
              <div className="flex items-center justify-between mb-2">
                <span className="text-xs uppercase tracking-wider text-zinc-400">Traffic (TomTom)</span>
                <span className="text-xs text-zinc-500">Live (falls Backend verbunden)</span>
              </div>
              {flow ? (
                <div className="space-y-2 text-sm text-zinc-300">
                  <div className="grid grid-cols-2 gap-2">
                    <div className="rounded-xl bg-zinc-900/60 p-3">Current Speed: <b>{flow.currentSpeed ?? "–"}</b> km/h</div>
                    <div className="rounded-xl bg-zinc-900/60 p-3">Free-Flow: <b>{flow.freeFlowSpeed ?? "–"}</b> km/h</div>
                    <div className="rounded-xl bg-zinc-900/60 p-3">Travel Time: <b>{flow.currentTravelTime ?? "–"}</b> s</div>
                    <div className="rounded-xl bg-zinc-900/60 p-3">Confidence: <b>{flow.confidence ?? "–"}</b></div>
                  </div>
                </div>
              ) : (
                <div className="text-zinc-400 text-sm">
                  Backend nicht verbunden. Lege auf deinem Server <code>api_flow.php</code> & <code>api_incidents.php</code> an (wie in unserem Beispiel) und lade die Seite neu.
                </div>
              )}
            </div>
          </div>
        </section>

        <footer className="mt-8 text-xs text-zinc-500 flex items-center justify-between">
          <span>Open‑Meteo Air Quality • TomTom Traffic • Demo UI</span>
          <span>© Smog Bharat</span>
        </footer>
      </div>
    </div>
  );
}
